# Cloudflare Worker Configuration for Proof-of-Build Orchestrator
# This is a template - copy to apps/worker/wrangler.toml and customize
#
# TEMPORARY: Using polling worker instead of queues (free tier)
# TODO: After 2 weeks, uncomment queue implementation and comment out cron trigger

name = "proof-of-build-worker"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# ============================================================================
# QUEUE CONSUMER CONFIGURATION (COMMENTED OUT - REQUIRES PAID PLAN)
# TODO: Uncomment after moving to paid plan (in ~2 weeks)
# ============================================================================
# # Queue Consumer Configuration
# # The Worker consumes messages from the queue triggered by R2 event notifications
# [[queues.consumers]]
# queue = "proof-of-build-queue"
# max_batch_size = 10
# max_batch_timeout = 30
# max_retries = 3
# dead_letter_queue = "proof-of-build-queue-dlq"  # Optional: for failed messages
# ============================================================================

# ============================================================================
# TEMPORARY: CRON TRIGGER FOR POLLING (FREE TIER)
# TODO: Comment out after moving to paid plan and uncommenting queue above
# ============================================================================
# Cron trigger: Runs every 2 minutes to poll for new manifest.json files
# This replaces the queue-based event notification system
[triggers]
crons = ["*/2 * * * *"]  # Every 2 minutes
# ============================================================================

# R2 Bucket Bindings
# All buckets use the same physical bucket (proof-of-build-uploads)
# but are logically separated by directory structure

[[r2_buckets]]
binding = "UPLOADS_BUCKET"
bucket_name = "proof-of-build-uploads"
# Used for: Reading artifacts (frames, terminal, logs, manifest.json)

[[r2_buckets]]
binding = "SCRIPTS_BUCKET"
bucket_name = "proof-of-build-uploads"
# Used for: Writing generated scripts (scripts/{project_id}.json)

[[r2_buckets]]
binding = "AUDIO_BUCKET"
bucket_name = "proof-of-build-uploads"
# Used for: Writing generated audio (audio/{project_id}.m4a)

[[r2_buckets]]
binding = "STATE_BUCKET"
bucket_name = "proof-of-build-uploads"
# Used for: Reading/writing state files (state/{project_id}.json)

# AI Binding (Workers AI)
[ai]
binding = "AI"
# Used for: Script generation using Cloudflare Workers AI

# Environment Variables
# These should be set via: wrangler secret put <KEY>
[vars]
# No public variables - all secrets use wrangler secret put

# Secrets (set via: wrangler secret put <KEY>)
# ELEVENLABS_API_KEY - API key for ElevenLabs audio generation
# AI_API_KEY - API key for AI script generation (if using external AI)

# Development Configuration
[env.development]
name = "proof-of-build-worker-dev"

[env.production]
name = "proof-of-build-worker"

# ============================================================================
# BINDING USAGE IN CODE
# ============================================================================
# In apps/worker/src/index.ts, access bindings like this:
# 
# TEMPORARY: Polling implementation (free tier)
# export default {
#   async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext): Promise<void> {
#     // Poll R2 for new manifest.json files and process them
#     // Access R2 buckets via bindings
#     const uploads = env.UPLOADS_BUCKET;
#     const scripts = env.SCRIPTS_BUCKET;
#     const audio = env.AUDIO_BUCKET;
#     const state = env.STATE_BUCKET;
#     
#     // Access secrets
#     const elevenLabsKey = env.ELEVENLABS_API_KEY;
#     const aiKey = env.AI_API_KEY;
#     
#     // Polling logic here...
#   }
# }
# 
# TODO: After moving to paid plan, use queue handler instead:
# export default {
#   async queue(batch: MessageBatch<QueueMessage>, env: Env): Promise<void> {
#     // Access R2 buckets via bindings
#     const uploads = env.UPLOADS_BUCKET;
#     const scripts = env.SCRIPTS_BUCKET;
#     const audio = env.AUDIO_BUCKET;
#     const state = env.STATE_BUCKET;
#     
#     // Access secrets
#     const elevenLabsKey = env.ELEVENLABS_API_KEY;
#     const aiKey = env.AI_API_KEY;
#   }
# }
# ============================================================================
# 
# SETUP INSTRUCTIONS:
# 1. Create the R2 bucket: wrangler r2 bucket create proof-of-build-uploads
# 2. Set secrets: wrangler secret put ELEVENLABS_API_KEY (and AI_API_KEY if needed)
# 3. Deploy worker: wrangler deploy (cron trigger will be automatically configured)
# 
# Note: Queue and event notification setup is skipped (using polling instead)
# See infra/README.md for more details

